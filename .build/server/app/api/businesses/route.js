"use strict";(()=>{var e={};e.id=201,e.ids=[201],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},47579:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{GET:()=>h,dynamic:()=>d});var o=s(79182),a=s(72007),n=s(56719),i=s(93442),c=s(57978),l=s(11826),p=s(89591),u=s(83178);let d="force-dynamic";async function h(e){try{let e=await (0,c.getServerSession)(l.L);if(!e?.user?.id)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,p.qb)(e.user.id);if(!t)return i.NextResponse.json({error:"Google access token not found"},{status:401});let s=new p.$w(t),r=(await s.getBusinessAccounts()).accounts||[],o=[];for(let t of r)try{for(let r of(await s.getBusinessLocations(t.name)).locations||[]){let t={googleId:r.name,name:r.title||r.name,address:r.storefrontAddress?`${r.storefrontAddress.addressLines?.join(", ")}, ${r.storefrontAddress.locality}, ${r.storefrontAddress.administrativeArea} ${r.storefrontAddress.postalCode}`:"",phoneNumber:r.primaryPhone||null,websiteUrl:r.websiteUrl||null,category:r.primaryCategory?.displayName||null,isVerified:!!r.metadata?.mapsUrl},s=await u._.business.upsert({where:{googleId:t.googleId},update:t,create:{...t,userId:e.user.id}});o.push(s)}}catch(e){console.error(`Error fetching locations for account ${t.name}:`,e)}return i.NextResponse.json({businesses:o})}catch(e){return console.error("Error fetching businesses:",e),i.NextResponse.json({error:"Failed to fetch businesses"},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/businesses/route",pathname:"/api/businesses",filename:"route",bundlePath:"app/api/businesses/route"},resolvedPagePath:"/home/ubuntu/gold-standard-gbp-app/app/app/api/businesses/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:y}=g,w="/api/businesses/route";function x(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},11826:(e,t,s)=>{s.d(t,{L:()=>n});var r=s(88120),o=s(64617),a=s(83178);let n={adapter:(0,o.N)(a._),providers:[(0,r.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{scope:"openid email profile https://www.googleapis.com/auth/business.manage"}}})],session:{strategy:"jwt"},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t,account:s})=>(t&&(e.id=t.id,e.plan=t.plan),s&&(e.accessToken=s.access_token,e.refreshToken=s.refresh_token),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.plan=t.plan),e),async signIn({user:e,account:t}){if(t?.provider==="google")try{await a._.user.upsert({where:{email:e.email},update:{},create:{email:e.email,name:e.name,image:e.image,plan:"FREE"}})}catch(e){console.error("Error creating/updating user:",e)}return!0}}}},83178:(e,t,s)=>{s.d(t,{_:()=>o});var r=s(53524);let o=globalThis.prisma??new r.PrismaClient},89591:(e,t,s)=>{s.d(t,{$w:()=>o,qb:()=>a,u3:()=>i});var r=s(83178);class o{constructor(e){this.accessToken=e,this.baseUrl="https://mybusinessbusinessinformation.googleapis.com/v1",this.postsBaseUrl="https://mybusiness.googleapis.com/v4"}async getBusinessAccounts(){let e=await fetch(`${this.baseUrl}/accounts`,{headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!e.ok)throw Error(`Failed to fetch accounts: ${e.statusText}`);return e.json()}async getBusinessLocations(e){let t=await fetch(`${this.baseUrl}/accounts/${e}/locations`,{headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!t.ok)throw Error(`Failed to fetch locations: ${t.statusText}`);return t.json()}async createPost(e,t){let s=await fetch(`${this.postsBaseUrl}/${e}/localPosts`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){let e=await s.text();throw Error(`Failed to create post: ${s.statusText} - ${e}`)}return s.json()}async getPosts(e){let t=await fetch(`${this.postsBaseUrl}/${e}/localPosts`,{headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!t.ok)throw Error(`Failed to fetch posts: ${t.statusText}`);return t.json()}async deletePost(e){let t=await fetch(`${this.postsBaseUrl}/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!t.ok)throw Error(`Failed to delete post: ${t.statusText}`)}}async function a(e){try{let t=await r._.account.findFirst({where:{userId:e,provider:"google"}});if(!t?.access_token)return null;if(t.expires_at&&1e3*t.expires_at<Date.now()){let e=await n(t.refresh_token);if(e)return await r._.account.update({where:{id:t.id},data:{access_token:e.access_token,expires_at:e.expires_at}}),e.access_token;return null}return t.access_token}catch(e){return console.error("Error getting Google access token:",e),null}}async function n(e){try{let t=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:process.env.GOOGLE_CLIENT_ID,client_secret:process.env.GOOGLE_CLIENT_SECRET,refresh_token:e,grant_type:"refresh_token"})});if(!t.ok)throw Error("Failed to refresh token");let s=await t.json();return{access_token:s.access_token,expires_at:Math.floor(Date.now()/1e3)+s.expires_in}}catch(e){return console.error("Error refreshing Google token:",e),null}}function i(e){let t={name:"",languageCode:"en",summary:e.content,topicType:"STANDARD"};switch(e.imageUrl&&(t.media=[{mediaFormat:"PHOTO",sourceUrl:e.imageUrl}]),e.type){case"EVENT":t.topicType="EVENT",e.eventStartDate&&e.eventEndDate&&(t.event={title:e.title,schedule:{startDate:e.eventStartDate.toISOString().split("T")[0],startTime:e.eventStartDate.toISOString().split("T")[1].split(".")[0],endDate:e.eventEndDate.toISOString().split("T")[0],endTime:e.eventEndDate.toISOString().split("T")[1].split(".")[0]}});break;case"OFFER":t.topicType="OFFER",e.offerTerms&&(t.offer={termsConditions:e.offerTerms})}return t}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[372,25,609],()=>s(47579));module.exports=r})();